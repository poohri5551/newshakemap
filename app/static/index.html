<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>SHAKEMAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />

  <!-- Fonts & Leaflet CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin />
  <link rel="stylesheet" href="/static/style.css?v=4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° ops-only + ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ -->
  <style>
    .ops-only { display: none !important; }
    .ops-mode .ops-only { display: inline-flex !important; }

    .mmi-chip{
      display:inline-block; padding:6px 10px; border-radius:10px; font-weight:700;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.08);
      color:#000; cursor:pointer; user-select:none;
    }
    .mmi-sub{ display:block; font-size:16px; opacity:.9; margin-top:4px; }

    .tray-toggle i{ transition:transform .18s ease; }
    .top-right-buttons.collapsed .icon-btn:not(.tray-toggle){ display:none; }

    /* üîç ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á */
    .sim-tools .row { display:flex; gap:8px; }
    .sim-tools input[type="text"]{ flex:1; }
    .sim-results{
      margin-top:8px; max-height:200px; overflow:auto;
      border:1px solid #e5e8ee; border-radius:10px; display:none; background:#fff;
    }
    .sim-results .item{
      padding:8px 10px; border-bottom:1px dashed #eee; cursor:pointer;
    }
    .sim-results .item:last-child{ border-bottom:0; }
    .sim-results .item:hover{ background:rgba(0,0,0,.04); }
    .btn-outline { padding:8px 12px; border-radius:12px; background:transparent; border:1px dashed #b6bed0; cursor:pointer; }
    .hint { color:#667085; }
  </style>

  <!-- Firebase (Compat v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <script>
// ===== ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Å‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏£‡∏£‡πÄ‡∏ó‡∏≤‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ =====
const NEED_OPTIONS = [
  {value:'medical',     label:'‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏¢‡∏≤'},
  {value:'food',        label:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏™‡∏ö‡∏µ‡∏¢‡∏á'},
  {value:'water',       label:'‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°'},
  {value:'shelter',     label:'‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á/‡∏ú‡πâ‡∏≤‡∏´‡πà‡∏°'},
  {value:'rescue',      label:'‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢'},
  {value:'evac',        label:'‡∏≠‡∏û‡∏¢‡∏û/‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢'},
  {value:'power',       label:'‡πÑ‡∏ü‡∏ü‡πâ‡∏≤/‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü'},
  {value:'comms',       label:'‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£/‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì'},
  {value:'sanitation',  label:'‡∏™‡∏∏‡∏Ç‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢/‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥'},
  {value:'transport',   label:'‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á'},
  {value:'special',     label:'‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å/‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏Å‡∏≤‡∏£'},
  {value:'pets',        label:'‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á/‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå'},
  {value:'psych',       label:'‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏¥‡∏ï‡πÉ‡∏à'}
];

function needLabel(v){ const o = NEED_OPTIONS.find(x=>x.value===v); return o?o.label:v; }

function initNeedDropdown(){
  const dd = document.getElementById('needDropdown');
  if(!dd) return;
  const ul = dd.querySelector('.need-dd-list');
  ul.innerHTML = '';
  NEED_OPTIONS.forEach(o=>{
    const li = document.createElement('li');
    li.innerHTML = `<label><input type="checkbox" value="${o.value}"><span>${o.label}</span></label>`;
    ul.appendChild(li);
  });

  // preload ‡∏à‡∏≤‡∏Å localStorage
  try{
    const saved = JSON.parse(localStorage.getItem('shakemapProfile')||'{}');
    if(saved.needs && Array.isArray(saved.needs)){
      ul.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        cb.checked = saved.needs.includes(cb.value);
      });
      updateNeedToggleText();
    }
  }catch(e){}

  // events
  const toggleBtn = dd.querySelector('.need-dd-toggle');
  const search = dd.querySelector('.need-dd-search input');
  const clearBtn = dd.querySelector('.need-dd-clear');
  const doneBtn = dd.querySelector('.need-dd-done');

  toggleBtn.addEventListener('click', ()=>{
    const open = dd.getAttribute('data-open') === 'true';
    dd.setAttribute('data-open', String(!open));
    toggleBtn.setAttribute('aria-expanded', String(!open));
  });

  document.addEventListener('click', (e)=>{
    if(!dd.contains(e.target)){
      dd.setAttribute('data-open','false');
      toggleBtn.setAttribute('aria-expanded','false');
    }
  });

  ul.addEventListener('change', updateNeedToggleText);

  search.addEventListener('input', ()=>{
    const q = search.value.trim().toLowerCase();
    ul.querySelectorAll('li').forEach(li=>{
      const text = li.textContent.toLowerCase();
      li.style.display = text.includes(q) ? '' : 'none';
    });
  });

  clearBtn.addEventListener('click', ()=>{
    ul.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
    updateNeedToggleText();
  });
  doneBtn.addEventListener('click', ()=>{
    dd.setAttribute('data-open','false');
    toggleBtn.setAttribute('aria-expanded','false');
  });
}

function getSelectedNeeds(){
  const dd = document.getElementById('needDropdown');
  if(!dd) return [];
  return Array.from(dd.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
}

function updateNeedToggleText(){
  const dd = document.getElementById('needDropdown');
  if(!dd) return;
  const placeholder = dd.querySelector('.need-dd-placeholder');
  const counter = dd.querySelector('.need-dd-count');
  const selected = getSelectedNeeds();
  if(selected.length === 0){
    placeholder.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‚Ä¶';
    counter.hidden = true;
  }else if(selected.length <= 2){
    placeholder.textContent = selected.map(needLabel).join(', ');
    counter.hidden = true;
  }else{
    placeholder.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
    counter.hidden = false;
    counter.textContent = selected.length;
  }
}

/* ==== ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ==== */
function saveNicknameAndNeeds(){
  const nickEl = document.getElementById('nicknameInput') || document.querySelector('#nickname input, #nickInput');
  const nickname = nickEl ? nickEl.value.trim() : '';
  const needs = getSelectedNeeds();

  const profile = { nickname, needs };
  localStorage.setItem('shakemapProfile', JSON.stringify(profile));

  try{ updateUserMarkerPopup && updateUserMarkerPopup(); }catch(e){}
  try{
    (document.getElementById('nicknameModal') || document.querySelector('.nickname-modal'))?.classList.remove('open');
  }catch(e){}
}

/* ==== Hook ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î ==== */
document.addEventListener('DOMContentLoaded', ()=>{
  initNeedDropdown();
  const btn = document.getElementById('nicknameSaveBtn') || document.querySelector('.nickname-save');
  if(btn) btn.addEventListener('click', saveNicknameAndNeeds);
});
</script>


  <div class="controls">
    <div class="controls-row">
      <!-- Search -->
      <div class="searchbox">
        <input id="searchInput" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" autocomplete="off" />
        <button id="searchBtn" type="button" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
        <ul id="acList" class="ac"></ul>
      </div>

      <!-- Nickname -->
      <button id="nickChip" class="chip-btn" type="button" title="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠">
        <span id="nickChipLabel">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
      </button>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô -->
      <div class="top-right-buttons">
        <button id="trayToggle" class="icon-btn tray-toggle" title="‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π" aria-label="‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π" aria-expanded="true">
          <i class="fa-solid fa-chevron-right"></i>
        </button>

        <button id="locateBtn" class="icon-btn" title="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
          </svg>
        </button>

        <button id="runBtn" class="icon-btn" title="‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß" aria-label="‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">
          <i class="fa-solid fa-house-crack"></i>
        </button>

        <button id="simulateBtn" class="icon-btn" title="‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà)" aria-label="‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà)">
          <i class="fa-solid fa-wave-square"></i>
        </button>

        <button id="clearPinsBtn" class="icon-btn ops-only" title="‡∏•‡πâ‡∏≤‡∏á Pins" aria-label="‡∏•‡πâ‡∏≤‡∏á Pins">
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="map"></div>
  <div id="toast" class="toast" style="display:none"></div>

  <!-- PGA Legend -->
  <div id="legend" class="legend" style="display:none">
    <div class="legend-title"><strong>PGA (%g)</strong></div>
    <div class="legend-bar"></div>
    <div class="legend-labels"></div>
  </div>

  <!-- Modal: ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô -->
  <div id="nickModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <button type="button" id="nickCloseX" class="modal-close" aria-label="‡∏õ‡∏¥‡∏î">
        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
      </button>

      <h3 class="modal-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
      <form id="nickForm" class="modal-body">
        <div class="row">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
            <input id="nickModalInput" type="text" maxlength="24" placeholder="">
          </label>
        </div>
        <!-- ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Dropdown ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) -->
<div class="field-group">
  <label class="label">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label>

  <div id="needDropdown" class="need-dd" data-open="false">
    <button type="button" class="need-dd-toggle" aria-haspopup="listbox" aria-expanded="false">
      <span class="need-dd-placeholder">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‚Ä¶</span>
      <span class="need-dd-count" hidden></span>
      <svg class="need-dd-caret" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M7 10l5 5 5-5z"></path>
      </svg>
    </button>

    <div class="need-dd-menu" role="listbox" aria-multiselectable="true">
      <div class="need-dd-search">
        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶">
      </div>
      <ul class="need-dd-list"><!-- options ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS --></ul>
      <div class="need-dd-actions">
        <button type="button" class="need-dd-clear">‡∏•‡πâ‡∏≤‡∏á</button>
        <button type="button" class="need-dd-done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
      </div>
    </div>
  </div>

  <div class="hint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
</div>

        <div class="modal-actions">
          <button type="button" id="nickCancel" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå -->
  <div id="simulateModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <button type="button" id="simCloseX" class="modal-close" aria-label="‡∏õ‡∏¥‡∏î">
        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
      </button>

      <h3 class="modal-title">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h3>
      <form id="simulateForm" class="modal-body">
        <div class="row">
          <label>Latitude
            <input id="simLat" type="number" step="0.0001" min="-90" max="90" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563">
          </label>
        </div>
        <div class="row">
          <label>Longitude
            <input id="simLon" type="number" step="0.0001" min="-180" max="180" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 100.5018">
          </label>
        </div>
        <div class="row">
          <label>Depth (km)
            <input id="simDepth" type="number" step="0.1" min="0" max="700" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 10">
          </label>
        </div>
        <div class="row">
          <label>Magnitude (Mw)
            <input id="simMag" type="number" step="0.1" min="1" max="10" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 5.5">
          </label>
        </div>
        <!-- üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
        <div class="sim-tools" style="margin-top:10px">
          <button type="button" id="simPickBtn" class="btn-outline">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
          <div class="hint" style="margin-top:6px">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å Latitude/Longitude ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
        </div>

        <div class="modal-actions" style="margin-top:14px">
          <button type="button" id="simCancel" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" id="simSubmit" class="btn-primary">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏•‡πâ‡∏≤‡∏á Pins -->
  <div id="clearPinsModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h3 class="modal-title">‡∏•‡πâ‡∏≤‡∏á Pins ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
      <form id="clearPinsForm" class="modal-body">
        <div class="row">
          <label>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            <input id="clearCodeInput" type="password" autocomplete="off" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™">
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" id="clearCancel" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" id="clearConfirm" class="btn-primary">‡∏•‡∏ö‡πÄ‡∏•‡∏¢</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î MMI -->
  <div id="mmiModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h3 id="mmiModalTitle" class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (MMI)</h3>
      <div class="modal-body">
        <div id="mmiBadge" class="mmi-chip" style="margin-bottom:8px"></div>
        <div id="mmiDesc" class="mmi-sub"></div>
        <div id="mmiDamage" class="mmi-sub"></div>
        <div id="mmiAdvice" style="margin-top:10px;line-height:1.55"></div>
        <div id="mmiRange" class="mmi-sub" style="margin-top:8px"></div>
        <div id="mmiPGA" class="mmi-sub"></div>
      </div>
      <div class="modal-actions">
        <button type="button" id="mmiClose" class="btn-primary">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- Modal: ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
  <div id="queueModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h3 class="modal-title">‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‚Ä¶</h3>
      <div class="modal-body">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <div class="spinner" aria-hidden="true"></div>
          <div id="queueText" class="queue-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‚Ä¶</div>
        </div>
        <div class="queue-metrics">
          <div class="metric">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <b id="qActive">-</b></div>
          <div class="metric">‡∏à‡∏≥‡∏Å‡∏±‡∏î: <b id="qLimit">10</b></div>
        </div>
        <div style="margin-top:8px">
          ‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span id="queuePosition" class="queue-pos">#‚Äì</span>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" id="queueLeave" class="btn-secondary">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin></script>

  <script>
    /* === Overlay color mapping (‡∏à‡∏≤‡∏Å legend) === */
    let currentLegend = null;

    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||"");
      if(!m) return {r:0,g:0,b:0};
      return { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) };
    }

    function colorForPGAFromLegend(pga){
      const L = currentLegend;
      if(!L || !L.stops || L.stops.length < 2) return '#000';
      const min = +L.min, max = +L.max;
      const span = (max - min) || 1e-9;
      let t = (pga - min) / span;
      if(!isFinite(t)) t = 0;
      t = Math.max(0, Math.min(1, t));

      const N = L.stops.length;
      const x = t * (N - 1);
      const i = Math.floor(x);
      if (i >= N - 1) return L.stops[N - 1].color;

      const f = x - i;
      const c1 = hexToRgb(L.stops[i].color);
      const c2 = hexToRgb(L.stops[i+1].color);
      const r = Math.round(c1.r + f*(c2.r - c1.r));
      const g = Math.round(c1.g + f*(c2.g - c1.g));
      const b = Math.round(c1.b + f*(c2.b - c1.b));
      return `rgb(${r},${g},${b})`;
    }


    /* ---------------- Helpers ---------------- */
    function toast(msg, isError=false){
      const t = document.getElementById('toast');
      t.textContent = msg || '';
      t.classList.toggle('error', !!isError);
      t.style.display = msg ? 'block' : 'none';
      if(msg){ clearTimeout(toast._tmr); toast._tmr = setTimeout(()=>t.style.display='none', 4000); }
    }
    function _esc(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ---------------- Map base ---------------- */
    const osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap' });
    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ maxZoom:19, attribution:'Tiles &copy; Esri' });
    const baseLayers = { "OpenStreetMap": osm, "Esri World Imagery": esri };

    const pgaImageGroup   = L.layerGroup();
    const epicenterGroup  = L.layerGroup();
    const legendLayer     = L.layerGroup();
    const othersPinsGroup = L.layerGroup();

    const map = L.map('map', {
      center:[15,100], zoom:6,
      layers:[osm, pgaImageGroup, epicenterGroup, othersPinsGroup]
    });

    map.createPane('pinsPane');
    map.getPane('pinsPane').style.zIndex = 610;

    const layerControl = L.control.layers(
      baseLayers,
      { 'PGA (Interpolation)': pgaImageGroup, 'Pins from everyone': othersPinsGroup, 'PGA Scale Bar': legendLayer }
    ).addTo(map);
    layerControl.setPosition('bottomright');
    map.zoomControl.setPosition('bottomright');

    /* ---------------- State ---------------- */
    let overlayLayer=null, epicenterMarker=null, searchMarker=null, userDistanceLine=null;
    let lastPGAData=null, lastPGAGrid=[], lastEpicenter=null;

    /* ---------------- Icons ---------------- */
    const blueIcon = L.icon({
      iconUrl:'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-blue.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
    });
    const redIcon = L.icon({
      iconUrl:'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
    });

    /* ---------------- PGA ‚Üí MMI (Worden+2012) ---------------- */
    const PGA_THRESH = [0.05, 0.3, 2.8, 6.2, 12, 22, 40, 75, 139];
    const MMI_CODES  = ["I","II‚ÄìIII","IV","V","VI","VII","VIII","IX","X","X+"];
    const MMI_COLORS = [
      "#efeaff","#cfd8ff","#66ccff","#6bd86b","#d6f24a",
      "#ffe066","#ff9b40","#ff4d3a","#d8222a","#990000"
    ];
    const TH_SHAKING = ["‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å","‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‚Äì‡∏≠‡πà‡∏≠‡∏ô","‡∏≠‡πà‡∏≠‡∏ô","‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á","‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÅ‡∏£‡∏á","‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å","‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á","‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å","‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å (Violent)","‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Extreme)"];
    const TH_DAMAGE  = ["‡πÑ‡∏°‡πà‡∏°‡∏µ","‡πÑ‡∏°‡πà‡∏°‡∏µ","‡πÑ‡∏°‡πà‡∏°‡∏µ","‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÅ‡∏ï‡∏Å‡∏Ç‡∏≠‡∏á‡∏ú‡∏ô‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ö‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢","‡∏ú‡∏ô‡∏±‡∏á/‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏á‡∏´‡∏•‡πà‡∏ô‡∏ö‡∏≤‡∏á‡∏à‡∏∏‡∏î ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏ô‡πÄ‡∏Å‡∏£‡πá‡∏î‡πÅ‡∏ï‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏≤‡∏ß","‡∏ö‡πâ‡∏≤‡∏ô/‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å (‡∏ú‡∏ô‡∏±‡∏á‡πÅ‡∏ï‡∏Å‡∏£‡πâ‡∏≤‡∏ß, ‡πÄ‡∏™‡∏≤‡∏õ‡∏π‡∏ô‡∏ö‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏£‡πâ‡∏≤‡∏ß)","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á (‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏≠‡∏¥‡∏ê‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏´‡∏•‡πá‡∏Å, ‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤) ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏û‡∏±‡∏á‡∏ó‡∏•‡∏≤‡∏¢","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ó‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏û‡∏±‡∏á‡∏ñ‡∏•‡πà‡∏°‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏û‡∏±‡∏á‡∏ñ‡∏•‡πà‡∏°"];

    const MMI_ADVICE = {
      "I":"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£",
      "II‚ÄìIII":"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£",
      "IV":"‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô",
      "V":"‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ‡πÇ‡∏ï‡πä‡∏∞/‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏ö‡∏±‡∏á ‡∏¢‡∏∂‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏•‡πâ‡∏° ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô",
      "VI":"‡∏´‡∏•‡∏ö‡πÉ‡∏ï‡πâ‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏∏‡∏°‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏û‡∏¢‡∏û‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢",
      "VII":"‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô/‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏£‡∏±‡πà‡∏ß",
      "VIII":"‡∏≠‡∏û‡∏¢‡∏û‡πÑ‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏™‡∏∞‡∏û‡∏≤‡∏ô ‡πÄ‡∏™‡∏≤‡πÑ‡∏ü",
      "IX":"‡∏≠‡∏û‡∏¢‡∏û‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
      "X":"‡∏≠‡∏û‡∏¢‡∏û‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
      "X+":"‡∏≠‡∏û‡∏¢‡∏û‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏Å‡∏ä‡∏ô‡∏¥‡∏î"
    };

    function mmiFromPGA(pgaPercentG){
      let idx = 0; while (idx < PGA_THRESH.length && pgaPercentG >= PGA_THRESH[idx]) idx++;
      const lower = idx === 0 ? 0 : PGA_THRESH[idx-1];
      const upper = idx < PGA_THRESH.length ? PGA_THRESH[idx] : Infinity;
      const rangeText = idx === 0 ? `< ${PGA_THRESH[0]}%g` : (upper === Infinity ? `‚â• ${lower}%g` : `${lower}‚Äì${upper}%g`);
      return { idx, code:MMI_CODES[idx], color:MMI_COLORS[idx], shake:TH_SHAKING[idx], damage:TH_DAMAGE[idx], rangeText };
    }

    /* ---------------- PGA Compute ---------------- */
    function resetLatest(){
      if (overlayLayer && pgaImageGroup.hasLayer(overlayLayer)) pgaImageGroup.removeLayer(overlayLayer);
      overlayLayer = null;
      if (epicenterMarker && epicenterGroup.hasLayer(epicenterMarker)) epicenterGroup.removeLayer(epicenterMarker);
      epicenterMarker = null;
      if (userDistanceLine && map.hasLayer(userDistanceLine)) map.removeLayer(userDistanceLine);
      userDistanceLine = null;
      lastPGAData=null; lastPGAGrid=[]; lastEpicenter=null;
      const lg = document.getElementById('legend'); if (lg) lg.style.display = 'none';
      setLegendVisible(false); if (map.hasLayer(legendLayer)) map.removeLayer(legendLayer);
    }

    let _btnTmr=null;
    function setRunBtnTimer(running){
      const btn = document.getElementById('runBtn');
      if (_btnTmr) { clearInterval(_btnTmr); _btnTmr=null; }
      btn.disabled = !!running;
      btn.innerHTML = `<i class="fa-solid fa-house-crack" aria-hidden="true"></i>`;
    }

    async function runCompute(opts = {}){
      const useTimer = opts.timer !== false;
      if (useTimer) setRunBtnTimer(true);
      toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å TMD ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PGA ...');
      try{
        resetLatest();
        const res = await fetch('/api/run', { method:'POST', headers:{ 'Content-Type':'application/json' }, body:'{}' });
        if(!res.ok) throw new Error((await res.text()) || ('HTTP '+res.status));
        const data = await res.json();

        renderLegend(data.legend);
        if (!map.hasLayer(legendLayer)) legendLayer.addTo(map);
        setLegendVisible(true);

        if(data.error) throw new Error(data.error);

        const { bounds, epicenter, image_data_url, popup_html, meta, pga_points } = data;
        lastPGAGrid = Array.isArray(pga_points) ? pga_points : [];

        overlayLayer = L.imageOverlay(image_data_url, bounds, { opacity:0.75 });
        pgaImageGroup.addLayer(overlayLayer);

        epicenterMarker = L.marker(epicenter, { title:'Epicenter', icon:redIcon });
        if (popup_html) epicenterMarker.bindPopup(popup_html, { maxWidth:320, autoPan:true });
        epicenterGroup.addLayer(epicenterMarker);
        if (popup_html) epicenterMarker.openPopup();

        map.fitBounds(bounds, { padding:[20,20] });
        const MIN_ZOOM_ON_EVENT = 12;
        const fitZ = map.getBoundsZoom(L.latLngBounds(bounds), true);
        const targetZ = Math.max(fitZ + 1, MIN_ZOOM_ON_EVENT);
        map.flyTo(epicenter, targetZ, { duration: 0.6 });

        lastEpicenter = epicenter;
        lastPGAData  = { bounds, epicenter, image_data_url, popup_html, meta };
        toast(`‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏ß‡∏•‡∏≤ ${meta?.time_th || '-'}, ${meta?.changwat || '-'}`);
        updateUserMarkerPopup(); drawUserDistanceLine();
      }catch(err){
        console.error(err);
        toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(err.message||err), true);
      }finally{
        if (useTimer) setRunBtnTimer(false);
      }
    }

    /* ---------------- Utilities ---------------- */
    function calcDistanceKm(lat1, lon1, lat2, lon2){
      const R=6371, toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function classifySeverity(pga){
      if (pga === 0) return { label:"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö", className:"sev-none" };
      if (pga <= 3.6) return { label:"‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡πà‡∏≥",  className:"sev-low" };
      if (pga <= 9.6) return { label:"‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏≤‡∏á", className:"sev-mid" };
      return { label:"‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á", className:"sev-high" };
    }
    function findNearestPGA(lat, lon, limitKm=8){
      if (!lastPGAGrid.length) return null;
      const toRad = d=>d*Math.PI/180, R=6371;
      let best=null, bestD=Infinity;
      for(const p of lastPGAGrid){
        const dLat = toRad(p.lat-lat), dLon = toRad(p.lon-lon);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat))*Math.cos(toRad(p.lat))*Math.sin(dLon/2)**2;
        const d = 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        if (d < bestD) { bestD = d; best = p; }
      }
      return (best && bestD <= limitKm) ? {...best, dist:bestD} : null;
    }

    /* ---------------- Popup: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ MMI + ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ---------------- */
    /* ---------------- Popup: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ MMI + ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ---------------- */
/* ---------------- Popup: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ MMI + ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ---------------- */
/* ---------------- Popup: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ MMI + ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ---------------- */
function updateUserMarkerPopup(){
  if (!searchMarker) return;

  const latlng = searchMarker.getLatLng();
  let popup = searchMarker.options.title || '';

  if (lastEpicenter && latlng){
    const dist = calcDistanceKm(latlng.lat, latlng.lng, lastEpicenter[0], lastEpicenter[1]);
    popup += `<br><span>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á : <b>${dist.toFixed(2)}</b> ‡∏Å‡∏°.</span>`;

    if (lastPGAGrid.length){
      const pgaObj = findNearestPGA(latlng.lat, latlng.lng, 8);
      const pgaVal = (pgaObj && isFinite(pgaObj.pga) && pgaObj.pga > 0) ? pgaObj.pga : 0;

      const sev = classifySeverity(pgaVal);
      const m   = mmiFromPGA(pgaVal);
      const mmiOverlayColor = colorForPGAFromLegend(pgaVal);

      // ‡∏ñ‡πâ‡∏≤ MMI ‡πÄ‡∏õ‡πá‡∏ô I ‡∏´‡∏£‡∏∑‡∏≠ II‚ÄìIII ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á MMI IV" ‡πÅ‡∏ó‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
      const MMI_IV_COLOR = (typeof MMI_COLORS !== 'undefined' && MMI_COLORS[2]) || '#66ccff';
      const textColor = (m.code === 'I' || m.code === 'II‚ÄìIII') ? MMI_IV_COLOR : m.color;

      // ‡∏Ñ‡πà‡∏≤ PGA (%g) ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô" ‡πÉ‡∏ä‡πâ textColor ‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
      popup += `<br><span>‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô : <b style="color:${textColor}">${pgaVal.toFixed(4)}</b> %g</span>`;
      popup += `<br><span style="color:${textColor}; font-weight:700">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô : ${sev.label}</span>`;

      // ‡∏õ‡πâ‡∏≤‡∏¢ MMI (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á MMI) + ‡πÄ‡∏â‡∏î‡∏™‡∏µ overlay
      popup += `
        <br><span>MMI :
          <a href="#"
             onclick="return showMMIDetail('${m.code}', ${Number(pgaVal).toFixed(6)})"
             class="mmi-chip"
             style="background:${m.color}; text-decoration:none;">
            ${m.code}
          </a>
          <span class="pga-chip" style="background:${mmiOverlayColor}" title="‡πÄ‡∏â‡∏î‡∏™‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà"></span>
        </span>
      `;

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      try{
        const profile = JSON.parse(localStorage.getItem('shakemapProfile')||'{}');
        if (profile.needs && profile.needs.length){
          const chips = profile.needs.map(v=>`<span class="need-chip">${needLabel(v)}</span>`).join(' ');
          popup += `<br><span>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ : ${chips}</span>`;
        }
      }catch(e){}
    }
  }

  searchMarker.getPopup()?.setContent(popup);
}


    function drawUserDistanceLine(){
      if (userDistanceLine) { map.removeLayer(userDistanceLine); userDistanceLine=null; }
      if (!searchMarker || !lastEpicenter) return;
      const u = searchMarker.getLatLng();
      userDistanceLine = L.polyline([ [u.lat,u.lng], [lastEpicenter[0],lastEpicenter[1]] ],
        { color:"#ff0080", weight:3, dashArray:"8 8", opacity:.95, lineCap:"round", zIndex:9999 }).addTo(map);
    }

    /* ---------------- Search & Autocomplete ---------------- */
    const acList = document.getElementById('acList');
    const searchInput = document.getElementById('searchInput');
    let acResults = []; let acSelected = -1;

    const debounce = (fn, wait=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };
    const debouncedSearch = debounce(() => doSearch(searchInput.value.trim()), 350);
    const showAC = show => acList.style.display = (show && acResults.length) ? 'block' : 'none';

    async function queryNominatim(q, limit = 6) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&accept-language=th&limit=${limit}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Nominatim error ' + res.status);
      return await res.json();
    }
    async function queryPhoton(q, limit = 6) {
      const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&lang=th&limit=${limit}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Photon error ' + res.status);
      const data = await res.json();
      return (data.features || []).map(f => ({
        lat: f.geometry.coordinates[1],
        lon: f.geometry.coordinates[0],
        display_name: f.properties.name
          ? `${f.properties.name}${f.properties.city ? ', '+f.properties.city : ''}${f.properties.country ? ', '+f.properties.country : ''}`
          : (f.properties.city || f.properties.country || '')
      }));
    }

    async function doSearch(q){
      if (!q) { showAC(false); return; }
      try {
        toast('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "' + q + '" ...');
        let results = [];
        try { results = await queryNominatim(q, 8); }
        catch(e) { results = await queryPhoton(q, 8); }
        acResults = results; acSelected = -1;
        acList.innerHTML = results.map((it, idx) => {
          const display = it.display_name || it.name || '';
          const parts = display.split(',');
          const main = _esc((parts[0] || '').trim() || '(‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠)');
          const sub = _esc(parts.slice(1).join(',').trim());
          return `<li data-idx="${idx}"><span class="ac-main">${main}</span><span class="ac-sub">${sub ? ', '+sub : ''}</span></li>`;
        }).join('');
        showAC(true);
      } catch (e) {
        console.error(e);
        toast('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (e.message || e), true);
        showAC(false);
      }
    }

    function updateACActive() {
      Array.from(acList.children).forEach((li, i) => li.classList.toggle('active', i === acSelected));
    }
    function selectAC(idx) {
      const it = acResults[idx]; if (!it) return;
      showAC(false); acResults = []; acSelected = -1; searchInput.value = '';
      const lat = parseFloat(it.lat), lon = parseFloat(it.lon);
      const display = it.display_name || '';
      if (searchMarker) map.removeLayer(searchMarker);
      const title = display + (currentNickname ? ` <br><small>(‡∏â‡∏±‡∏ô: ${_esc(currentNickname)})</small>` : '');
      searchMarker = L.marker([lat, lon], { title, icon: blueIcon }).addTo(map);
      searchMarker.bindPopup(title, { maxWidth: 320, autoPan: true }).openPopup();
      map.flyTo([lat, lon], 13, { duration: 0.6 });
      toast('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (display || `(${lat.toFixed(5)}, ${lon.toFixed(5)})`));
      updateUserMarkerPopup(); drawUserDistanceLine(); saveMyPin(lat, lon, display);
    }

    let searching=false;
    document.getElementById('searchBtn').addEventListener('click', async () => {
      if (searching) return;
      const q = searchInput.value.trim(); if (!q) return;
      try { searching = true; await doSearch(q); if (acResults.length) selectAC(0); }
      finally { searching = false; }
    });
    acList.addEventListener('mousedown', e => {
      let li = e.target; while (li && li.tagName !== 'LI') li = li.parentElement;
      if (li) selectAC(+li.getAttribute('data-idx'));
    });
    document.addEventListener('mousedown', e => { if (!acList.contains(e.target) && e.target !== searchInput) showAC(false); });
    searchInput.addEventListener('input', () => { if (searchInput.value.trim()) debouncedSearch(); else showAC(false); });
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); if (acSelected >= 0) selectAC(acSelected); else if (acResults.length) selectAC(0); else doSearch(searchInput.value.trim()).then(()=>{ if (acResults.length) selectAC(0); }); }
      else if (e.key === 'ArrowDown') { if (acResults.length) { acSelected = Math.min(acSelected + 1, acResults.length - 1); updateACActive(); showAC(true); } e.preventDefault(); }
      else if (e.key === 'ArrowUp')   { if (acResults.length) { acSelected = Math.max(acSelected - 1, 0); updateACActive(); showAC(true); } e.preventDefault(); }
      else if (e.key === 'Escape') showAC(false);
    });

    /* ---------------- Locate & Click ---------------- */
    let locateCooldown=false;

    // üîñ ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á
    window.__simPickOnce = false;

    async function locateMe(){
      if (locateCooldown) return; locateCooldown=true; setTimeout(()=>locateCooldown=false, 2000);
      toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...');
      if (!navigator.geolocation) return toast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', true);
      navigator.geolocation.getCurrentPosition(async pos=>{
        const { latitude, longitude } = pos.coords;
        try{
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}&accept-language=th&zoom=12&addressdetails=1`;
          const res = await fetch(url); const data = await res.json();
          const display = data.display_name || '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô';
          if (searchMarker) map.removeLayer(searchMarker);
          const title = display + (currentNickname ? ` <br><small>(‡∏â‡∏±‡∏ô: ${_esc(currentNickname)})</small>` : '');
          searchMarker = L.marker([latitude,longitude], { title, icon: blueIcon }).addTo(map);
          searchMarker.bindPopup(title, { maxWidth:320, autoPan:true }).openPopup();
          map.flyTo([latitude, longitude], 13, { duration: 0.6 });
          toast('‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß');
          updateUserMarkerPopup(); drawUserDistanceLine(); saveMyPin(latitude, longitude, display);
        }catch(err){ toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: '+(err.message||err), true); }
      }, err=>toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: '+err.message, true));
    }
    document.getElementById('locateBtn').addEventListener('click', locateMe);

        map.on('click', async e => {
        const { lat, lng } = e.latlng;

        // ‚Äî‚Äî ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡∏ß‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏î‡πÜ ‚Äî‚Äî
        if (window.__simPickOnce) {
          window.__simPickOnce = false;
          try { map.getContainer().style.cursor = ''; } catch(e){}
          const simLatEl = document.getElementById('simLat');
          const simLonEl = document.getElementById('simLon');
          if (simLatEl && simLonEl) {
            simLatEl.value = lat.toFixed(4);
            simLonEl.value = lng.toFixed(4);
          }
          toast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
          const _modal = document.getElementById('simulateModal');
          if (_modal) _modal.style.display = 'flex'; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
          return; // ‚Üê‚Üê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏à‡∏ö‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠ (‡πÑ‡∏°‡πà‡∏ß‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î/‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÑ‡∏°‡πà reverse)
        }
      // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
      toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...');
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=th&zoom=12&addressdetails=1`;
        const res = await fetch(url); const data = await res.json();
        const display = data.display_name || `(${lat.toFixed(5)}, ${lng.toFixed(5)})`;
        if (searchMarker) map.removeLayer(searchMarker);
        const title = display + (currentNickname ? ` <br><small>(‡∏â‡∏±‡∏ô: ${_esc(currentNickname)})</small>` : '');
        searchMarker = L.marker([lat,lng], { title, icon: blueIcon }).addTo(map);
        searchMarker.bindPopup(title, { maxWidth:320, autoPan:true }).openPopup();
        toast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß');
        updateUserMarkerPopup(); drawUserDistanceLine(); saveMyPin(lat, lng, display);
      }catch(err){ toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: '+(err.message||err), true); }
    });

    map.on('popupopen', (e)=>{ if (searchMarker && e.popup === searchMarker.getPopup()) updateUserMarkerPopup(); });

    function updatePGAVisibility(){
      const has = map.hasLayer(pgaImageGroup);
      if (!has){ if (overlayLayer) pgaImageGroup.removeLayer(overlayLayer), overlayLayer=null; }
      else{ if (!overlayLayer && lastPGAData){ overlayLayer = L.imageOverlay(lastPGAData.image_data_url, lastPGAData.bounds, { opacity:.75 }); pgaImageGroup.addLayer(overlayLayer); } }
    }
    map.on('overlayadd overlayremove', e=>{ if (e.layer === pgaImageGroup) updatePGAVisibility(); });
    document.getElementById('runBtn').addEventListener('click', runCompute);

    function setLegendVisible(show){ document.getElementById('legend').style.display = show ? 'block' : 'none'; }
    map.on('overlayadd',   e => { if (e.layer === legendLayer) setLegendVisible(true);  });
    map.on('overlayremove',e => { if (e.layer === legendLayer) setLegendVisible(false); });

    function renderLegend(legend){
      currentLegend = legend;
      const box = document.getElementById('legend');
      if(!legend){ box.style.display = 'none'; return; }

      const bar = box.querySelector('.legend-bar');
      const labels = box.querySelector('.legend-labels');
      const title = box.querySelector('.legend-title');
      title.textContent = `PGA (${legend.units||'%g'})`;

      // ‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏µ: ‡πÉ‡∏ä‡πâ bounds + colors ‡∏™‡∏£‡πâ‡∏≤‡∏á hard-steps
      if (legend.mode === 'discrete' && Array.isArray(legend.bounds) && Array.isArray(legend.colors)) {
        const min = legend.min, max = legend.max;
        const bounds = legend.bounds.slice(0, -1); // ‡∏ï‡∏±‡∏î inf ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢
        const colors = legend.colors;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (%) ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏≠‡∏ö
        const pos = bounds.map(v => ((v - min) / (max - min)) * 100);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á CSS gradient ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô: ‡∏™‡∏µ i ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà pos[i] ‡∏ñ‡∏∂‡∏á pos[i+1]
        const parts = [];
        for (let i=0; i<colors.length; i++){
          const p0 = Math.max(0, Math.min(100, pos[i] || 0));
          const p1 = Math.max(0, Math.min(100, pos[i+1] ?? 100));
          parts.push(`${colors[i]} ${p0}%`, `${colors[i]} ${p1}%`);
        }
        bar.style.background = `linear-gradient(to right, ${parts.join(', ')})`;

        // ‡∏õ‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ (‡πÄ‡∏≠‡∏≤ min/max)
        labels.innerHTML = `<span><strong>${min}</strong></span><span><strong>${max}</strong></span>`;
        box.style.display = 'block';
        return;
      }

      // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏° (gradient ‡∏•‡∏∑‡πà‡∏ô ‡πÜ ‡∏ï‡∏≤‡∏° stops)
      if(!legend.stops || !legend.stops.length){ box.style.display = 'none'; return; }
      const grad = legend.stops.map((s,i)=>`${s.color} ${(i/(legend.stops.length-1))*100}%`).join(', ');
      bar.style.background = `linear-gradient(to right, ${grad})`;
      labels.innerHTML = `<span><strong>${legend.min.toFixed(0)}</strong></span><span><strong>${legend.max.toFixed(4)}</strong></span>`;
      box.style.display = 'block';
    }

    /* ---------------- Firebase Pins + Nickname ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB3hdNequpq1BUT9Bzg-HobLCTtdRDTAEA",
      authDomain: "shakemap-d69a8.firebaseapp.com",
      projectId: "shakemap-d69a8",
      storageBucket: "shakemap-d69a8.firebasestorage.app",
      messagingSenderId: "626217349401",
      appId: "1:626217349401:web:332f3dcc26af9dd8e49588",
      measurementId: "G-JH9E5GM3EX"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.firestore();
    let currentUser=null; const othersMarkers=new Map();

    auth.signInAnonymously().catch(console.error);
    auth.onAuthStateChanged(u => { currentUser = u || null; if (currentUser) subscribePins(); });

    (() => {
      const OPS_CODE='123456', OPS_TTL_MS=60*1000, LS_KEY='opsModeUntil', q=new URLSearchParams(location.search);
      function setOpsMode(on){ on ? localStorage.setItem(LS_KEY, String(Date.now()+OPS_TTL_MS)) : localStorage.removeItem(LS_KEY); document.body.classList.toggle('ops-mode', on); }
      function isOpsMode(){ const exp=+localStorage.getItem(LS_KEY)||0; if(exp && Date.now()<exp) return true; localStorage.removeItem(LS_KEY); return false; }
      function askCode(){ const code=prompt('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏±‡∏ö:'); if(!code) return false; if(code===OPS_CODE){ setOpsMode(true); toast('‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); return true; } toast('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true); return false; }
      if (q.get('ops')==='1'){ setOpsMode(true); history.replaceState({}, '', location.pathname + location.hash); } else { setOpsMode(isOpsMode()); }
      document.addEventListener('keydown', e=>{ if (e.altKey && e.shiftKey && e.code==='KeyO'){ e.preventDefault(); askCode(); } });
      let taps=0,last=0; document.addEventListener('click', e=>{ const inTopRight = e.clientX>(innerWidth-120)&&e.clientY<120; if(!inTopRight) return; const now=Date.now(); taps = (now-last<600)?taps+1:1; last=now; if(taps>=5){ taps=0; askCode(); } });
      window.exitOpsMode=()=>setOpsMode(false);
    })();

Ôªø    let currentNickname='';
    function loadNickname(){ try{ currentNickname = localStorage.getItem('nick') || ''; }catch(e){ currentNickname=''; } }
    function saveNickname(nick){
      currentNickname=(nick||'').trim();
      try{ localStorage.setItem('nick', currentNickname); }catch(e){}
      toast(currentNickname ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${currentNickname}` : '‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    }
    window.addEventListener('DOMContentLoaded', () => { loadNickname(); });

    function colorFromUid(uid){ let h=0; for(let i=0;i<uid.length;i++) h=(h*31 + uid.charCodeAt(i))>>>0; const hue=h%360; return `hsl(${hue} 90% 45%)`; }
    function makeCircleMarker(lat, lon, options={}){ return L.circleMarker([lat, lon], Object.assign({ radius:7, weight:2, fillOpacity:.9, opacity:1, pane:'pinsPane' }, options)); }

    async function saveMyPin(lat, lon, label){
      try{
        if (!currentUser) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (Anonymous Auth)');

        let needs = [];
        try{
          const profile = JSON.parse(localStorage.getItem('shakemapProfile')||'{}');
          if (Array.isArray(profile.needs)) needs = profile.needs;
        }catch(e){}

        await db.collection('pins').doc(currentUser.uid).set({
          uid: currentUser.uid, nick: currentNickname || '', label, lat, lon,
          needs,
          ts: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      }catch(e){
        console.error('saveMyPin error:', e.code, e.message);
        toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e), true);
      }
    }

    function subscribePins(){
      db.collection('pins').orderBy('ts', 'desc').onSnapshot(snap=>{
        const seen = new Set();
        snap.forEach(doc=>{
          const id=doc.id, d=doc.data(); seen.add(id);
          const color=colorFromUid(d.uid||id);
          const owner=(d.nick||'').trim()?_esc(d.nick.trim()):String(d.uid||id).slice(0,8);
          let html = `<div style="font-weight:700">${_esc(d.label||'‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å')}</div>
            <div>Lat ${(+d.lat).toFixed(5)}, Lon ${(+d.lon).toFixed(5)}</div>
            <div style="margin-top:4px;font-size:12px;opacity:.8">‡πÇ‡∏î‡∏¢: ${owner}</div>`;

          if (Array.isArray(d.needs) && d.needs.length){
            const chips = d.needs.map(v=>`<span class="need-chip">${needLabel(v)}</span>`).join(' ');
            html += `<div style="margin-top:6px">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ : ${chips}</div>`;
          }

          let mk=othersMarkers.get(id);
          if(!mk){ mk = makeCircleMarker(d.lat,d.lon,{ color, fillColor: color }); mk.bindPopup(html, { maxWidth:280, autoPan:true }); othersPinsGroup.addLayer(mk); othersMarkers.set(id,mk); }
          else{ mk.setLatLng([d.lat,d.lon]); mk.setStyle({ color, fillColor: color }); mk.getPopup()?.setContent(html); }
        });
        for (const [id, mk] of othersMarkers){ if (!seen.has(id)){ othersPinsGroup.removeLayer(mk); othersMarkers.delete(id); } }
      }, err=>{ console.error(err); toast('‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err.message||err), true); });
    }

    /* ===== Nickname: Chip + Modal ===== */
    window.addEventListener('DOMContentLoaded', () => {
      const chip      = document.getElementById('nickChip');
      const chipLabel = document.getElementById('nickChipLabel');
      const modal     = document.getElementById('nickModal');
      const form      = document.getElementById('nickForm');
      const input     = document.getElementById('nickModalInput');
      const btnCancel = document.getElementById('nickCancel');
      const btnCloseX = document.getElementById('nickCloseX');

      function refreshChip(){
        chipLabel.textContent = (currentNickname && currentNickname.trim())
          ? `‡∏â‡∏±‡∏ô: ${currentNickname.trim()}`
          : '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
      }
      function showNickModal(show=true){
        if (!modal) return;
        if (show){
          input.value = currentNickname || '';
          modal.style.display = 'flex';
          setTimeout(()=>input?.focus(), 30);
        }else{
          modal.style.display = 'none';
        }
      }

      chip?.addEventListener('click', () => showNickModal(true));
      btnCancel?.addEventListener('click', () => showNickModal(false));
      btnCloseX?.addEventListener('click', () => showNickModal(false));
      modal?.addEventListener('click', (e)=>{ if(e.target===modal) showNickModal(false); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal?.style.display === 'flex') showNickModal(false);
      });

      form?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const v = (input.value || '').trim();
        saveNickname(v);
        saveNicknameAndNeeds();
        refreshChip();
        showNickModal(false);
      });

      refreshChip();
    });

    /* ====== Simulate dialog ====== */
    window.addEventListener('DOMContentLoaded', () => {
      const modalEl=document.getElementById('simulateModal');
      const simBtn=document.getElementById('simulateBtn');
      const simForm=document.getElementById('simulateForm');
      const simLat=document.getElementById('simLat');
      const simLon=document.getElementById('simLon');
      const simDepth=document.getElementById('simDepth');
      const simMag=document.getElementById('simMag');
      const simCancel=document.getElementById('simCancel');
      const simCloseX=document.getElementById('simCloseX');

      // ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
      const simSearch = document.getElementById('simSearch');
      const simSearchBtn = document.getElementById('simSearchBtn');
      const simResults = document.getElementById('simResults');
      const simPickBtn = document.getElementById('simPickBtn');

      function showSimModal(show=true){
        if(!modalEl) return;
        modalEl.style.display = show ? 'flex' : 'none';
        if(!show){
          if (simResults){ simResults.innerHTML=''; simResults.style.display='none'; }
          window.__simPickOnce=false;
        }
      }
      // === ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏≠‡∏• ===
      const SIM_URL = 'https://simulateeq.onrender.com/';   // ‚Üê ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      simBtn?.addEventListener('click', () => {
        // ‡πÄ‡∏õ‡∏¥‡∏î ‚Äú‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‚Äù
        window.open(SIM_URL, '_blank', 'noopener');

        // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ô ‚Äú‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏ó‡∏ô:
        // location.assign(SIM_URL);
      });
      simCancel?.addEventListener('click', ()=> showSimModal(false));
      simCloseX?.addEventListener('click', ()=> showSimModal(false));
      modalEl?.addEventListener('click', e=>{ if (e.target===modalEl) showSimModal(false); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modalEl?.style.display === 'flex') showSimModal(false);
      });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á
      function renderSimResults(list){
        simResults.innerHTML = '';
        if (!list || !list.length){ simResults.style.display='none'; return; }
        list.forEach(it=>{
          const div = document.createElement('div');
          div.className = 'item';
          const name = it.display_name || it.name || `${it.lat}, ${it.lon}`;
          div.textContent = name;
          div.addEventListener('click', ()=> {
            simLat.value = (+it.lat).toFixed(4);
            simLon.value = (+it.lon).toFixed(4);
            if (window.map) map.setView([+it.lat, +it.lon], Math.max(map.getZoom(), 10));
            // ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î!
            simResults.innerHTML = '';
            simResults.style.display = 'none';
          });

          simResults.appendChild(div);
        });
        simResults.style.display='block';
      }

      async function doSimSearch(q){
        if (!q || q.trim().length<2){ renderSimResults([]); return; }
        try {
          let results=[];
          try{ results = await queryNominatim(q, 8); }
          catch(e){ results = await queryPhoton(q, 8); }
          renderSimResults(results);
        }catch(e){
          console.error(e);
          toast('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏≠‡∏•) ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+(e.message||e), true);
          renderSimResults([]);
        }
      }

      // ‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß auto-pick ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
      simSearchBtn?.addEventListener('click', async ()=>{
        await doSimSearch(simSearch.value);
        const first = simResults.querySelector('.item');
        if (first) first.click();
      });
      simSearch?.addEventListener('keydown', async (e)=>{
        if (e.key==='Enter'){
          e.preventDefault();
          await doSimSearch(simSearch.value);
          const first = simResults.querySelector('.item');
          if (first) first.click();
        }
      });

      // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
      simPickBtn?.addEventListener('click', () => {
          window.__simPickOnce = true;                 // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          try { map.getContainer().style.cursor = 'crosshair'; } catch(e){}
          toast('‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î');
          const modalEl = document.getElementById('simulateModal');
          if (modalEl) modalEl.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        });

      let _simTmr=null;
      function setSimBtnTimer(running){ const b=document.getElementById('simulateBtn'); if(!b) return; if(_simTmr){ clearInterval(_simTmr); _simTmr=null; } b.disabled=!!running; b.innerHTML=`<i class="fa-solid fa-wave-square"></i>`; }

      async function simulateCompute(lat, lon, depth, mag){
        setSimBtnTimer(true); toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‚Ä¶');
        try{
          resetLatest();
          const res = await fetch('/api/simulate', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ lat, lon, depth, mag }) });
          if(!res.ok) throw new Error((await res.text()) || ('HTTP '+res.status));
          const data = await res.json();
          if(data.error) throw new Error(data.error);

          renderLegend(data.legend);
          if (!map.hasLayer(legendLayer)) legendLayer.addTo(map);
          setLegendVisible(true);

          const { bounds, epicenter, image_data_url, popup_html, meta, pga_points } = data;
          lastPGAGrid = Array.isArray(pga_points) ? pga_points : [];

          overlayLayer = L.imageOverlay(image_data_url, bounds, { opacity:0.75 });
          pgaImageGroup.addLayer(overlayLayer);

          epicenterMarker = L.marker(epicenter, { title:'Sim Epicenter', icon:redIcon });
          if (popup_html) epicenterMarker.bindPopup(popup_html, { maxWidth:320, autoPan:true });
          epicenterGroup.addLayer(epicenterMarker);
          if (popup_html) epicenterMarker.openPopup();

          map.fitBounds(bounds, { padding:[20,20] });
          const MIN_ZOOM_ON_EVENT = 12;
          const fitZ = map.getBoundsZoom(L.latLngBounds(bounds), true);
          const targetZ = Math.max(fitZ + 1, MIN_ZOOM_ON_EVENT);
          map.flyTo(epicenter, targetZ, { duration: 0.6 });

          lastEpicenter = epicenter;
          lastPGAData  = { bounds, epicenter, image_data_url, popup_html, meta };
          toast(`‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏à‡∏≥‡∏•‡∏≠‡∏á Mw ${meta?.mag ?? meta?.mag_api ?? mag}, depth ${meta?.depth_km ?? depth} km`);
          updateUserMarkerPopup(); drawUserDistanceLine();
        }catch(err){ console.error(err); toast('‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+(err.message||err), true); }
        finally{ setSimBtnTimer(false); }
      }

      simForm?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const lat=parseFloat(simLat.value), lon=parseFloat(simLon.value), depth=parseFloat(simDepth.value), mag=parseFloat(simMag.value);
        if(!Number.isFinite(lat) || lat<-90 || lat>90)       return toast('Latitude ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
        if(!Number.isFinite(lon) || lon<-180 || lon>180)     return toast('Longitude ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
        if(!Number.isFinite(depth) || depth<0 || depth>700)  return toast('Depth 0‚Äì700 km ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', true);
        if(!Number.isFinite(mag) || mag<1 || mag>10)         return toast('Magnitude 1.0‚Äì10.0 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', true);
        showSimModal(false); simulateCompute(lat, lon, depth, mag);
      });
    });

    /* ====== Clear Pins ====== */
    (function(){
      const CLEAR_CODE="123456";
      const modal=document.getElementById('clearPinsModal');
      const form=document.getElementById('clearPinsForm');
      const input=document.getElementById('clearCodeInput');
      const btn=document.getElementById('clearPinsBtn');
      const btnCancel=document.getElementById('clearCancel');

      function showClearModal(show=true){ if(!modal) return; modal.style.display = show ? 'flex' : 'none'; if (show){ input.value=""; setTimeout(()=>input?.focus(), 50); } }

      async function deletePinsBatch(limit=300){
        const FieldPath=firebase.firestore.FieldPath;
        const snap=await db.collection('pins').orderBy(FieldPath.documentId()).limit(limit).get();
        if (snap.empty) return 0;
        const batch=db.batch(); snap.forEach(doc=>batch.delete(doc.ref)); await batch.commit(); return snap.size;
      }
      async function clearAllPins(){
        btn.disabled=true; toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö Pins ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Ä¶');
        let total=0, removed;
        try{ do{ removed=await deletePinsBatch(300); total+=removed; }while(removed>0);
             toast(`‡∏•‡∏ö Pins ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`); }
        catch(e){ console.error(e); toast('‡∏•‡∏ö Pins ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e), true); }
        finally{ btn.disabled=false; }
      }

      btn?.addEventListener('click', ()=> showClearModal(true));
      btnCancel?.addEventListener('click', ()=> showClearModal(false));
      modal?.addEventListener('click', e=>{ if (e.target===modal) showClearModal(false); });
      form?.addEventListener('submit', async e=>{
        e.preventDefault();
        const code=(input.value||"").trim();
        if(!code) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™', true);
        if(code!==CLEAR_CODE) return toast('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
        showClearModal(false); await clearAllPins();
      });
    })();

    /* ====== Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î MMI ====== */
    function showMMIDetail(code, pgaVal){
      const idx = MMI_CODES.indexOf(code);
      if (idx < 0) return false;

      const m = {
        code,
        color: MMI_COLORS[idx],
        shake: TH_SHAKING[idx],
        damage: TH_DAMAGE[idx],
        advice: MMI_ADVICE[code] || "-",
        range: (function(){
          const lower = idx === 0 ? 0 : PGA_THRESH[idx-1];
          const upper = idx < PGA_THRESH.length ? PGA_THRESH[idx] : Infinity;
          return idx === 0 ? `< ${PGA_THRESH[0]}%g` : (upper===Infinity ? `‚â• ${lower}%g` : `${lower}‚Äì${upper}%g`);
        })()
      };

      const modal = document.getElementById('mmiModal');
      const badge = document.getElementById('mmiBadge');
      document.getElementById('mmiModalTitle').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (MMI ${m.code})`;
      badge.style.background = m.color;
      badge.textContent = `MMI ${m.code}`;
      document.getElementById('mmiDesc').textContent   = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å: ${m.shake}`;
      document.getElementById('mmiDamage').textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ${m.damage}`;
      document.getElementById('mmiAdvice').innerHTML   = `<b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b> ${_esc(m.advice)}`;

      modal.style.display = 'flex';
      function close(){ modal.style.display='none'; modal.removeEventListener('click', onBack); closeBtn.removeEventListener('click', close); }
      function onBack(e){ if (e.target === modal) close(); }
      const closeBtn = document.getElementById('mmiClose');
      modal.addEventListener('click', onBack);
      closeBtn.addEventListener('click', close);

      return false;
    }

    // ====== Toggle ‡∏ñ‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤ (‡∏û‡∏±‡∏ö/‡∏Å‡∏≤‡∏á + ‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞) ======
    window.addEventListener('DOMContentLoaded', () => {
      const tray = document.querySelector('.top-right-buttons');
      const toggle = document.getElementById('trayToggle');

      function setCollapsed(c){
        tray.classList.toggle('collapsed', c);
        toggle.setAttribute('aria-expanded', String(!c));
        toggle.title = c ? '‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π' : '‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π';
        toggle.innerHTML = c
          ? '<i class="fa-solid fa-chevron-left"></i>'
          : '<i class="fa-solid fa-chevron-right"></i>';
        try{ localStorage.setItem('trayCollapsed', c ? '1' : '0'); }catch(e){}
      }

      const initCollapsed = (localStorage.getItem('trayCollapsed') === '1');
      setCollapsed(initCollapsed);
      toggle?.addEventListener('click', () => setCollapsed(!tray.classList.contains('collapsed')));
    });

    // ================= Queue Control (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô) =================
    (function(){
      const ENTER_URL = "/api/queue/enter";
      const STATUS_URL = "/api/queue/status";
      const HEARTBEAT_URL = "/api/queue/heartbeat";
      const LEAVE_URL = "/api/queue/leave";

      // gen ids
      function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16) ); }
      function getClientId(){ try{ let id=localStorage.getItem('clientId'); if(!id){ id=uuid(); localStorage.setItem('clientId', id); } return id; }catch(e){ return uuid(); } }
      function getTabId(){ try{ let id=sessionStorage.getItem('tabId'); if(!id){ id=uuid(); sessionStorage.setItem('tabId', id); } return id; }catch(e){ return uuid(); } }

      const clientId = getClientId();
      const tabId = getTabId();

      const modal = document.getElementById('queueModal');
      const txt   = document.getElementById('queueText');
      const posEl = document.getElementById('queuePosition');
      const leaveBtn = document.getElementById('queueLeave');
      const qActiveEl = document.getElementById('qActive');
      const qLimitEl  = document.getElementById('qLimit');

      let hbTimer=null, stTimer=null;
      let inQueue=false, isActive=false;

      function showQueueModal(show=true){
        if(!modal) return;
        modal.style.display = show ? 'flex' : 'none';
        document.body.classList.toggle('queue-wait', show);
      }

      async function apiPost(url, payload){
        const res = await fetch(url, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload||{})
        });
        return await res.json();
      }
      async function apiGet(url, params){
        const qs = new URLSearchParams(params||{}).toString();
        const res = await fetch(qs ? (url + "?" + qs) : url);
        return await res.json();
      }

      function renderQueueUI(state){
        if (qActiveEl && typeof state.active==='number') qActiveEl.textContent = String(state.active);
        if (qLimitEl && typeof state.limit==='number')   qLimitEl.textContent  = String(state.limit);
        if (state.position && posEl) posEl.textContent = `#${state.position}`;
      }

      function handleState(data){
        renderQueueUI(data||{});
        if(data?.state === 'active'){
          inQueue=false; isActive=true; showQueueModal(false);
          if(!hbTimer) heartbeatLoop();
        }else if(data?.state === 'queued'){
          inQueue=true; isActive=false;
          txt.textContent = `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö ${data.limit||'-'} ‡∏Ñ‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß...`;
          if (posEl && data.position) posEl.textContent = `#${data.position}`;
          showQueueModal(true);
          if(!stTimer) statusLoop();
        }else{
          inQueue=false; isActive=false;
          setTimeout(enter, 1000);
        }
      }

      async function enter(){
        try{ const d = await apiPost(ENTER_URL, { client_id: clientId, tab_id: tabId }); handleState(d); }
        catch(e){ console.error('enter error:', e); }
      }
      async function statusLoop(){
        clearTimeout(stTimer);
        try{ const d = await apiGet(STATUS_URL, { client_id: clientId, tab_id: tabId }); handleState(d); }
        catch(e){ console.error('status error:', e); }
        finally{ if(inQueue) stTimer = setTimeout(statusLoop, 3000); }
      }
      async function heartbeatLoop(){
        clearTimeout(hbTimer);
        try{ const d = await apiPost(HEARTBEAT_URL, { client_id: clientId, tab_id: tabId }); handleState(d); }
        catch(e){ console.error('heartbeat error:', e); }
        finally{ hbTimer = setTimeout(heartbeatLoop, 20000); }
      }
      function leave(){
        try{
          navigator.sendBeacon(LEAVE_URL, new Blob([JSON.stringify({ client_id: clientId, tab_id: tabId })], { type: 'application/json' }));
        }catch(e){}
      }
      leaveBtn?.addEventListener('click', () => {
        leave();
        try { window.close(); } catch(e) {}
        try {
          window.opener = null;
          window.open('', '_self');
          window.close();
        } catch(e) {}
        setTimeout(() => {
          try { window.location.replace('about:blank'); } catch(e) {}
          setTimeout(() => { try { window.close(); } catch(e) {} }, 50);
        }, 10);
      });

      window.addEventListener('beforeunload', leave);
      document.addEventListener('visibilitychange', () => {
        if(document.visibilityState === 'visible'){
          if(isActive){ heartbeatLoop(); }
          else if(inQueue){ statusLoop(); }
        }
      });

      window.addEventListener('DOMContentLoaded', () => { enter(); });
    })();

    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå active)
    window.addEventListener('DOMContentLoaded', () => {
      const runBtn = document.getElementById('runBtn');
      runBtn.disabled = true;
      setTimeout(() => {
        runCompute({ timer: false }).finally(() => {
          runBtn.disabled = false;
        });
      }, 300);
    });
  </script>
</body>
</html>
